package xyz.yooniks.exploitpatch.bukkit.listener;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.PacketType.Play.Client;
import com.comphenix.protocol.events.ListenerPriority;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketContainer;
import com.comphenix.protocol.events.PacketEvent;
import java.util.List;
import org.bukkit.GameMode;
import org.bukkit.Material;
import org.bukkit.entity.Player;
import org.bukkit.inventory.ItemStack;
import org.bukkit.plugin.Plugin;
import xyz.yooniks.exploitpatch.bukkit.ExploitPatchLogger;
import xyz.yooniks.exploitpatch.bukkit.connection.ConnectionCloser;
import xyz.yooniks.exploitpatch.bukkit.nbt.NBTChecker;

public class ItemPacketListener extends PacketAdapter {

  private final ConnectionCloser connectionCloser;
  private final List<NBTChecker> nbtCheckers;

  public ItemPacketListener(Plugin plugin, ConnectionCloser connectionCloser, List<NBTChecker> nbtCheckers, PacketType... packets) {
    super(plugin, ListenerPriority.LOWEST, packets);
    this.connectionCloser = connectionCloser;
    this.nbtCheckers = nbtCheckers;
  }

  @Override
  public void onPacketReceiving(PacketEvent event) {
    final Player player = event.getPlayer();
    if (player == null || this.connectionCloser.isClosing(player)) {
      event.setCancelled(true);
      return;
    }
    final PacketContainer packet = event.getPacket();
    if (packet.getItemModifier().size() == 0) {
      ExploitPatchLogger.warning(this.getClass().getSimpleName(),
          "No itemModifiers in packet! Please disable block-place in configuration.");
      return;
    }
    final ItemStack item = packet.getItemModifier().readSafely(0);
    if (item == null || item.getType() == Material.AIR) {
      return;
    }
    if (packet.getType() == Client.SET_CREATIVE_SLOT) {
      if (player.getGameMode() != GameMode.CREATIVE) {
        event.setCancelled(true);
        ExploitPatchLogger
            .info(player.getName(), "Trying to use setCreativeSlot packet without creative mode!");
        return;
      }
    }
    for (NBTChecker nbtChecker : this.nbtCheckers) {
      if (nbtChecker.isInvalid(player, item)) {
        event.setCancelled(true);
        this.connectionCloser.close(player);
        return;
      }
    }
  }

}
