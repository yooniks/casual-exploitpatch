package xyz.yooniks.exploitpatch.bukkit.listener;

import com.comphenix.protocol.PacketType.Play.Client;
import com.comphenix.protocol.events.ListenerPriority;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketEvent;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerQuitEvent;
import org.bukkit.plugin.Plugin;

public class ArmAnimationListener extends PacketAdapter implements Listener {

  private final long time;
  private final Map<UUID, Long> timestamp = new HashMap<>();

  public ArmAnimationListener(Plugin plugin, long time) {
    super(plugin, ListenerPriority.LOWEST, Client.ARM_ANIMATION);
    this.time = time;
  }

  @Override
  public void onPacketReceiving(PacketEvent event) {
    final Player player = event.getPlayer();
    if (player == null) {
      return;
    }
    final UUID uuid = player.getUniqueId();
    if (this.timestamp.containsKey(uuid)) {
      final long timestamp = this.timestamp.get(uuid);
      if (timestamp > System.currentTimeMillis()) {
        event.setCancelled(true);
        return;
      }
    }
    this.timestamp.put(uuid, System.currentTimeMillis() + this.time);
  }

  @EventHandler
  public void onQuit(PlayerQuitEvent event) {
    this.timestamp.remove(event.getPlayer().getUniqueId());
  }

}
