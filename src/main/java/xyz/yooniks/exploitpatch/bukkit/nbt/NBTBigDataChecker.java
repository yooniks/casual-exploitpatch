package xyz.yooniks.exploitpatch.bukkit.nbt;

import com.comphenix.protocol.wrappers.nbt.NbtCompound;
import com.comphenix.protocol.wrappers.nbt.NbtFactory;
import com.comphenix.protocol.wrappers.nbt.NbtList;
import org.bukkit.Material;
import org.bukkit.inventory.ItemStack;

public class NBTBigDataChecker implements NBTChecker {

  @Override
  public boolean isInvalid(ItemStack item) {
    //should i add limits in config?
    if (item == null || item.getType() == Material.AIR) {
      return false;
    }
    final NbtCompound compound = (NbtCompound) NbtFactory.fromItemTag(item);
    if (compound == null) {
      return false;
    }
    if (compound.getKeys().size() > 75 || compound.getValue().size() > 75) {
      return true;
    }
    return compound.getKeys().stream()
        .map(compound::getValue)
        .anyMatch(value -> value.getName().length() > 100
            || (value.getValue() instanceof String && ((String) value.getValue()).length() > 100)
            //not checking every tag in nbtlist =/ i hope it's not needed, cuz nbt has already some limit
            || (value instanceof NbtList && ((NbtList) value).size() > 55));
  }

}
