package xyz.yooniks.exploitpatch.bukkit.nbt;

import com.comphenix.protocol.wrappers.nbt.NbtCompound;
import com.comphenix.protocol.wrappers.nbt.NbtFactory;
import com.comphenix.protocol.wrappers.nbt.NbtList;
import org.bukkit.Material;
import org.bukkit.entity.Player;
import org.bukkit.inventory.ItemStack;
import xyz.yooniks.exploitpatch.bukkit.ExploitPatchLogger;

public class NBTBigDataChecker implements NBTChecker {

  private static final int MAX_SIMILAR_PAGES = 10;

  @Override
  public boolean isInvalid(Player player, ItemStack item) {
    //should i add limits in config?
    if (item == null || item.getType() == Material.AIR) {
      return false;
    }
    final NbtCompound compound = (NbtCompound) NbtFactory.fromItemTag(item);
    if (compound == null) {
      return false;
    }
    if (compound.getKeys().size() > 75 || compound.getValue().size() > 75) {
      ExploitPatchLogger.info(player.getName(), "Too big keys or values!");
      return true;
    }
    if (compound.containsKey("pages")) {
      final NbtList<String> listTag = compound.getList("pages");
      final int sizeOfPages = listTag.size();

      int similarPages = 0;
      String lastPage = "";

      if (sizeOfPages > 50) {
        ExploitPatchLogger.info(player.getName(), "Too many pages!");
        return true;
      }

      for (String page : listTag) {
        if (lastPage.equalsIgnoreCase(page)) {
          similarPages++;
        }
        lastPage = page;

        if (similarPages > MAX_SIMILAR_PAGES) {
          ExploitPatchLogger.info(player.getName(), "Too many similar pages! (" + similarPages
              + ", last page content: " + lastPage + ")");
          return true;
        }
        if (page.length() > 255) {
          ExploitPatchLogger.info(player.getName(), "Too big page!");
          return true;
        }
      }
    }
    return compound.getKeys().stream()
        .map(compound::getValue)
        .anyMatch(value -> value.getName().length() > 100
            || (value.getValue() instanceof String && ((String) value.getValue()).length() > 100)
            //not checking every tag in nbtlist =/ i hope it's not needed, cuz nbt has already some limit
            || (value instanceof NbtList && ((NbtList) value).size() > 55));
  }

}
